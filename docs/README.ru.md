# Yii2 Nested Field Validation

[[English](../README.md)]

Набор валидаторов для проверки данных, передаваемых во вложенных полях. Валидаторы позволяют проверять данные с помощью
стандартных валидаторов Yii2 как для вложенного объекта, так и для массива вложенных объектов. Валидаторы могут
визуализировать ошибки в классическом формате Yii2, в форме, визуально совместимой с json, и в формате, совместимом с
плагином [Yii2 Multiple Field Widget](https://github.com/matrozov/yii2-multiple-field-widget).

```json
{
  "field": [
    {
      "nested-field-1": "value 1",
      "nested-field-2": 25
    },
    {
      "nested-field-1": "value 2",
      "nested-field-2": 0
    }
  ]
}
```

Вы можете легко проверить указанный вложенный массив объектов следующим образом:

```php
public function rules(): array
{
    return [
        [['field'], KeyArrayValidator::class, 'rules' => [
            [['nested-field-1'], 'string', 'max' => 255],        
            [['nested-field-2'], 'integer'],        
        ]],
    ];
}
```

Вложенная проверка допускает неограниченную вложенность, а также все обычные валидаторы, включая проверку файлов.

## Установка

```bash
php composer.phar require matrozov/yii2-nested-field-validation "^1.0"
```

или добавив

```
"matrozov/yii2-nested-field-validation": "^1.0"
```

в секцию "require" в вашем `composer.json` файле.

## Usage

Мы предоставляем валидаторы на все случаи жизни. Вы можете валидировать как вложенную модель, массив вложенных моделей,
так и ключи такого массива.

Все валидаторы имеют возможность указать формат возвращаемых ошибок. Доступны следующие два формата ошибок:

**Validator::ERROR_FORMAT_URL** - формат, используемый по умолчанию. Совместим с плагином
[Yii2 Multiple Field Widget](https://github.com/matrozov/yii2-multiple-field-widget) для визуализации ошибок во View.
Вложенные поля с ошибками формируются как элементы в квадратных скобках:
```
my_field[0][title]
```

**Validator::ERROR_FORMAT_DOT** - Формат генерации поля, использующий точку «.» в качестве разделителя:
```
my_field.0.title
```
Обычно используется для визуализации ошибок на уровне API.

---

Формат ошибки можно задать глобально:
```php
Validator::$globalErrorFormat = Validator::ERROR_FORMAT_DOT;
```
и локально, на уровне любого валидатора, например:
```php
[['field'], ArrayValidator::class, 'rules' => [...], 'errorFormat' => Validator::ERROR_FORMAT_DOT],
```

### Validation concept

Механизм валидации предлагает два решения для валидации. Как в явном виде указывая правила валидации в рамках правил
основной модели:

```php
[['field'], KeyArrayValidator::class, 'rules' => [
    [['nested-field'], 'string'],
]],
```

так и в виде вынесения правил в отдельную модель:

```php
// MainModel rules
[['field'], KeyModelValidator::class, 'model' => FieldModel::class],
```
```php
// FieldModel rules
[['nested-field'], 'string'],
```

Вынесение правил в отдельную модель позволяет декомпозировать обработку вложенных сущностей вынося их из основной
модели. Загрузка данных и валидация во вложенной модели происходит классическим для Yii2 способом через применение
методов load() и validate(). Т.е. вы можете применять во вложенной модели привычные методы обработки и валидации
данных. Ошибки вложенной модели будут автоматически проброшены и конвертированы согласно формату в основную модель.

### Validator options

#### ArrayValidator & ModelValidator

Группа валидаторов предназначенная для валидации вложенного объекта.

```json
{
  "field": {
    "nested-field-1": "value",
    "nested-field-2": 25
  }
}
```

* ArrayValidator

```php
[['field'], ArrayValidator::class, 'rules' => [
    [['nested-field-1'], 'string'],
    [['nested-field-2'], 'integer'],
]],
```

Валидатор предлагает следующий набор свойств:
* **rules** (array) - Набор правил для валидации вложенного объекта.

* Model Validator

```php
// MainModel::rules
[['field'], ModelValidator::class, 'model' => FieldModel::class],
```
```php
//FieldModel::rules
[['nested-field-1'], 'string'],
[['nested-field-2'], 'integer'],
```

Валидатор предлагает следующий набор свойств:
* **model** (string|callable) - Класс модели для валидации вложенного объекта. Может быть указано в виде функции,
  в которую будет передана модель и аттрибут и ожидается возвращение объекта для валидации.
* **scenario** (string|callable) - Сценарий, устанавливаемый для вложенной модели перед вызовом метода load и validate.
  Может быть указано в виде функции, в которую будет передана модель и аттрибут и ожидается возвращение строки
  с названием сценария.
* **strictClass** (bool) - Не строгая проверка допускает использование наследуемого от указанного класса.

#### KeyValidator

```php
[['field'], KeyValidator::class, 'keyRules' => [
    ['string'],
]],
```

Валидатор для верификации ключей массива. Он не валидирует сами элементы, а только их ключи. Количество и
последовательность. При указании правил валидации ключей используется синтаксис аналогичный стандартному
валидатору EachValidator из пакета Yii2: в правиле валидации отсутствует перечисление полей, к которым применяется
правило валидации, а сразу указан сам валидатор. В отличие от стандартного EachValidator, KeyValidator допускает
указания сразу группы правил валидации.

Валидатор предлагает следующий набор свойств:
* **keyRules** (array) - Набор правил для валидации ключей массива.
* **messageArray** (string|null) - Текст сообщения, если значение указанного поля не является массивом.
* **keyIsIndexed** (bool) - Проверка, является ли переданное значение поля последовательным массивом, а не объектом, например.
* **messageKeyIsIndexed** (string|null) - Текст ошибки проверки на последовательный массив.
* **min** (int|null) - Минимальное количество элементов массива.
* **messageMin** (string|null) - Текст ошибки в случае, если в массиве элементов меньше указанного.
* **max** (int|null) - Максимальное количество элементов массива.
* **messageMax** (string|null) - Текст ошибки в случае, если в массиве элементов больше указанного.

#### KeyValueValidator

```json
{
  "field": [
    "value-1",
    "value-2"
  ]
}
```

Валидатор для верификации вложенных свойств массива. Он наследуется от KeyValidator и может валидировать сразу как
ключи, так и значения.

```php
[['field'], KeyValueValidator::class, 'rules' => [
    ['string'],
]],
```

Валидатор предлагает следующий набор свойств:
* **rules** (array) - Набор правил для валидации вложенного объекта.

При указании правил валидации используется синтаксис аналогичный стандартному
валидатору EachValidator из пакета Yii2: в правиле валидации отсутствует перечисление полей, к которым применяется
правило валидации, а сразу указан сам валидатор. В отличие от стандартного EachValidator, KeyValueValidator допускает
указания сразу группы правил валидации.

#### KeyArrayValidator & KeyModelValidator

Группа валидаторов предназначенная для валидации вложенного массива объектов. Он так же наследует KeyValidator.
Механизм валидации данных валидаторов является объединением механизмов таких классов валидаторов, как KeyValidator и
ArrayValidator/ModelValidator для валидации вложенных в массив моделей.

```json
{
  "field": [
    {
      "nested-field-1": "value",
      "nested-field-2": 25
    }
  ]
}
```

* KeyArrayValidator

```php
[['field'], KeyArrayValidator::class, 'rules' => [
    [['nested-field-1'], 'string'],
    [['nested-field-2'], 'integer'],
]],
```

Свойства валидатора идентичны свойствам KeyValidator и ArrayValidator.

* KeyModelValidator

```php
// MainModel::rules
[['field'], KeyModelValidator::class, 'model' => FieldModel::class], 
```

```php
// FieldModel::rules
[['nested-field-1'], 'string'],
[['nested-field-2'], 'integer'],
```

Свойства валидатора идентичны свойствам KeyValidator и ModelValidator.

## License

**yii2-nested-field-validation** выпущено под лицензией MIT. Подробную информацию см. в прилагаемой [лицензии](./LICENSE).
